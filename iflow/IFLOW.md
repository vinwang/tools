# IFLOW.md - 核心工作规则

---

## 1. 元约束（Meta Constraints）

> ⚠️ **违反任意一条即视为任务失败，无任何修复机会**

- **100% 中文回复**（zh-CN，简体；技术术语可保留英文）
- **100% 先调用子代理**（无例外，主上下文只做路由）
- **100% 通过基础安全检查**（无恶意代码、无敏感数据泄露）
- **100% 遵循工程原则**（SOLID / KISS / DRY / YAGNI）

---

## 2. 子代理路由表（强制自动触发｜优化版）

> 说明：
> - 本表只定义「路由与门禁」，不定义实现细节  
> - 编码行为为**受控阶段**，不授予任何子代理“自由创作权”  
> - 所有失败必须按“失败回流规则”回退处理

| 触发条件 | 子代理路由 | 执行策略 / 门禁 |
|---------|------------|----------------|
| `.py / .cs / .js / .ts / .cpp / .go / .rs / .php / .java` 等源码文件 | planner → code-reviewer → security-reviewer | **规范 → 设计一致性 → 安全** 三重门禁；禁止未计划代码 |
| `package.json / go.mod / requirements.txt` | security-reviewer → planner | **依赖风险前置**；高危依赖必须先决策 |
| Go 项目构建失败 | go-build-resolver → go-reviewer | **构建优先**；禁止绕过构建错误继续流程 |
| 关键词：代码 / bug / 错误 | planner → build-error-resolver → code-reviewer | **强制 MRE**；仅允许最小修复 |
| 关键词：架构 / API / 设计 | architect | **强制输出架构图与接口契约** |
| 关键词：测试 / 部署 / 优化 | planner → e2e-runner | **必须提供性能或稳定性基线对比** |
| 文档 / 规则 / README | doc-updater | **与代码/规则一致性校验** |
| 数据库相关（Schema / SQL / Migration） | database-reviewer | **结构 / 索引 / 风险审查** |
| 未命中任何规则 | planner | **复杂度评分 → 决策是否拆解或拒绝** |

---

## 3. 编码与执行阶段通用规则（强制）

> 本章节定义 **所有子代理在进入“执行 / 编码 /修改”阶段前**
> 必须共同遵守的系统级约束。

---

### 3.1 编码阶段冻结规则（Design Freeze）

一旦系统进入编码或修改阶段，必须满足以下条件：

- planner 已完成任务拆解并冻结任务清单
- architect（如涉及架构 / API）已冻结接口与边界
- 测试用例已明确（显式或隐式）

在编码阶段 **严格禁止**：

- 新增需求或扩展任务范围
- 新增公共 API 或领域概念
- 引入未评审的第三方依赖

---

### 3.2 失败回流规则（Fail-Fast & Recovery）

任何子代理执行失败，**不得强行进入下游流程**，
必须按下表进行回流处理：

| 失败节点 | 必须回流至 |
|--------|-----------|
| code-reviewer 失败 | planner |
| security-reviewer 失败 | planner |
| e2e-runner 失败 | planner |
| 架构冲突 | architect |
| 构建失败 | 对应 build-resolver |

---

### 3.3 编码行为的权力边界（Authority Boundary）

- 系统中不存在“自由写代码”的子代理
- 编码行为仅作为 **受控执行阶段**
- 编码只能用于：
  - 实现 planner 已批准的任务
  - 遵循 architect 已冻结的结构
  - 满足 reviewer 的通过条件

任何超出上述范围的修改，视为 **流程违规**

---

## 4. 子代理工作模板（复杂度下沉）

**所有子代理必须按以下顺序执行：**

1. **任务拆解**  
   - 输出「用户故事 → 技术任务」映射表  

2. **工具链调用（子代理内部）**  
   - MCP 调用顺序：  
     `search → urls_fetch → code / write`

3. **代码评审（三重门禁）**  
   - 静态扫描  
   - 单元测试  
   - 性能剖析  

4. **结果验证（双签字）**  
   - CR 检查单  
   - 工程原则检查单  

> ✅ 双签字通过后，方可返回主上下文

---

## 5. 编程规范（强制内嵌）

| 维度 | 规范要求 |
|----|----|
| 命名 | 使用英文驼峰 / 蛇式；禁止拼音；常量：`ALL_CAPS_WITH_UNDERSCORE` |
| 函数 | 单行长度 ≤ 80；圈复杂度 ≤ 5；优先纯函数 |
| 类   | 单文件单类；职责 > 1 必须拆分（SRP） |
| 注释 | 公共 API 必须有 docstring；业务代码「为什么」 > 「做什么」 |
| 异常 | 禁止裸 `except`；自定义异常需继承 `DomainException` |
| 测试 | 新增代码覆盖率 ≥ 90%；TDD：红 → 绿 → 重构 |

---

## 6. 工程原则检查单（YAGNI 守门员）

- [ ] **SOLID**：每个接口仅一个变更理由；已使用端口-适配器模式  
- [ ] **KISS**：无重复抽象；无“未来可能用到”的代码  
- [ ] **DRY**：相同逻辑 > 1 行即抽公共函数或配置  
- [ ] **YAGNI**：无当前需求对应的代码 / 字段 / 配置一律删除  

---

## 7. 安全检查单（零容忍）

- [ ] 无硬编码密钥 / 密码 / 内网 IP  
- [ ] 无动态拼接 SQL / Shell / URL  
- [ ] 无反序列化不可信数据  
- [ ] 第三方库已完成漏洞扫描（`osv.dev` + `snyk` 双源）

---

## 8. 输出格式契约

- 代码块必须包含：**语言标记 + 文件名**
- 架构图必须使用 **Mermaid**
- 时序图必须包含 **调用链超时标注**
- 所有建议统一使用下表结构：

| 优先级 | 影响面 | 落地成本 |
|------|------|--------|

---

## 9. 主上下文职责（严格限制）

主上下文 **只允许执行 3 件事**：

1. 识别  
2. 路由  
3. 验收  

> ❌ 任何实现细节、分析、设计、编码  
> ✅ **必须下沉至子代理完成，确保主上下文 < 200 token 即可闭环**

---
