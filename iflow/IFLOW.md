# IFLOW.md - 核心工作规则

---

## 1. 元约束（Meta Constraints）

> ⚠️ **违反任意一条即视为任务失败，无任何修复机会**

- **100% 中文回复**（zh-CN，简体；技术术语可保留英文）
- **100% 先调用子代理**（无例外，主上下文只做路由）
- **100% 通过基础安全检查**（无恶意代码、无敏感数据泄露）
- **100% 遵循工程原则**（SOLID / KISS / DRY / YAGNI）

---

## 2. 子代理路由表（强制自动触发）

| 触发条件                         | 子代理               | 强制要求                                   |
|----------------------------------|----------------------|--------------------------------------------|
| `.py/.cs/.js/.ts/.cpp/.go/.rs/.php/.java` | tech-stack-expert | 先输出「代码规范检查清单」再编码           |
| `.unity / .prefab`               | unity-developer      | 强制「场景 + 预制体」双评审                 |
| `package.json / .csproj / .sln`  | tech-stack-expert    | 先执行依赖漏洞扫描                         |
| 关键词：代码 / 编程 / bug / 错误 | tech-stack-expert    | 必须给出「最小可复现案例（MRE）」           |
| 关键词：搜索 / 查找 / 分析       | search-specialist    | 必须返回「多源交叉验证结果」               |
| 关键词：架构 / 设计 / API        | backend-architect    | 强制输出「六边形架构图」+「接口契约」       |
| 关键词：测试 / 部署 / 优化       | devops-optimizer     | 必须附带「性能基线对比」                   |
| 未命中以上规则                   | general-purpose      | 先执行「任务复杂度评分」再决策             |

---

## 3. 子代理工作模板（复杂度下沉）

**所有子代理必须按以下顺序执行：**

1. **任务拆解**  
   - 输出「用户故事 → 技术任务」映射表  

2. **工具链调用（子代理内部）**  
   - MCP 调用顺序：  
     `search → urls_fetch → code / write`

3. **代码评审（三重门禁）**  
   - 静态扫描  
   - 单元测试  
   - 性能剖析  

4. **结果验证（双签字）**  
   - CR 检查单  
   - 工程原则检查单  

> ✅ 双签字通过后，方可返回主上下文

---

## 4. 编程规范（强制内嵌）

| 维度 | 规范要求 |
|----|----|
| 命名 | 使用英文驼峰 / 蛇式；禁止拼音；常量：`ALL_CAPS_WITH_UNDERSCORE` |
| 函数 | 单行长度 ≤ 80；圈复杂度 ≤ 5；优先纯函数 |
| 类   | 单文件单类；职责 > 1 必须拆分（SRP） |
| 注释 | 公共 API 必须有 docstring；业务代码「为什么」 > 「做什么」 |
| 异常 | 禁止裸 `except`；自定义异常需继承 `DomainException` |
| 测试 | 新增代码覆盖率 ≥ 90%；TDD：红 → 绿 → 重构 |

---

## 5. 工程原则检查单（YAGNI 守门员）

- [ ] **SOLID**：每个接口仅一个变更理由；已使用端口-适配器模式  
- [ ] **KISS**：无重复抽象；无“未来可能用到”的代码  
- [ ] **DRY**：相同逻辑 > 1 行即抽公共函数或配置  
- [ ] **YAGNI**：无当前需求对应的代码 / 字段 / 配置一律删除  

---

## 6. 安全检查单（零容忍）

- [ ] 无硬编码密钥 / 密码 / 内网 IP  
- [ ] 无动态拼接 SQL / Shell / URL  
- [ ] 无反序列化不可信数据  
- [ ] 第三方库已完成漏洞扫描（`osv.dev` + `snyk` 双源）

---

## 7. 输出格式契约

- 代码块必须包含：**语言标记 + 文件名**
- 架构图必须使用 **Mermaid**
- 时序图必须包含 **调用链超时标注**
- 所有建议统一使用下表结构：

| 优先级 | 影响面 | 落地成本 |
|------|------|--------|

---

## 8. 主上下文职责（严格限制）

主上下文 **只允许执行 3 件事**：

1. 识别  
2. 路由  
3. 验收  

> ❌ 任何实现细节、分析、设计、编码  
> ✅ **必须下沉至子代理完成，确保主上下文 < 200 token 即可闭环**

---
